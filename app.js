const express = require('express')
require('dotenv').config()
const mongoose = require('mongoose')
const bodyParser = require('body-parser')
const nodemailer = require('nodemailer')
const passport = require('passport')
const session = require('express-session')
const LocalStrategy = require('passport-local').Strategy
const path = require('path')
const axios = require('axios')
const app = express()

app.use(express.json())
app.use(express.static(path.join(__dirname ,'frontend')))
app.use(bodyParser.urlencoded({extended:false}))

app.set("views", __dirname + "/views");
app.set("view engine", "ejs");

async function connectToMongoDB(){
    try{
        await mongoose.connect(process.env.uri,{
            useNewUrlParser: true,
      useUnifiedTopology: true,
      w:'majority' 
        })
        console.log('Connected to mongoDb')
    }
    catch(err){
        console.log(`error ${err}`)
    }
}

const User = new mongoose.Schema(
    {
        name: String,
        email: { type:String },
        phone: Number,
        date: Date
    }

)
const user = mongoose.model('user',User)

const feedback = new mongoose.Schema({
  name: String,
  email: String,
  message: String,
})

const feed = mongoose.model('feed',feedback)

app.get('/',async (req,res)=>{
   try{
    var feeds = await feed.find({})
    var feedList = [...feeds]
    res.render('index',{feedList:feedList})
   }
   catch(err){
    console.log(err)
   }
})
app.get('/book',(req,res)=>{
    res.sendFile(__dirname + '/frontend/book.html')
})

app.get('/feedback',(req,res)=>{
  res.sendFile(__dirname + '/frontend/feedback.html')
})

app.get('/ADMIN_ROUTE',async (req,res)=>{
  try{
    var feeds = await feed.find({})
    var feedlist = [...feeds]
    res.render('adminreview',{feedlist: feedlist})
  }

  catch(err){
    console.log(err)
  }
})
app.post('/ADMIN_ROUTE/:id',async(req,res)=>{
  try{
    let u = req.params.id
    await feed.findByIdAndDelete(u)
    res.redirect('/ADMIN_ROUTE')
  }
  catch(err){
    console.log(err)
  }
})

app.post('/thanks',async (req,res)=>{
  try{
    var {name,email,message} = req.body
    const fback = new feed({
      name: name,
      email: email,
      message: message
    })
    await fback.save()
    res.sendFile(__dirname + '/frontend/thanks.html')
  }
  catch(err){
    console.log(err)
  }

})
app.post('/', async (req, res) => {
    try {

      const message = req.body
      console.log(typeof message)

      const token = "kumkumsoudi"
       const a = await axios.post('https://surf-tasteful-swing.glitch.me', message , {headers:{
        Authorization: `Bearer ${token}`
    }}  )
       
       if(a) return res.sendFile(__dirname + '/frontend/success.html');
       
      
      // const { name, number, email, dateInput } = req.body;
      // const newUser = new user({
      //   name: name,
      //   email: email,
      //   phone: number,
      //   date: dateInput,
      // });
      // var thedate = dateInput
      // thedate = thedate.toString()
      // thedate = thedate.split("-").reverse(" ").join("-")
      // await newUser.save();
      // res.sendFile(__dirname + '/frontend/success.html');
      // console.log('New User Added');
  
      // // Create a Nodemailer transporter
      // let transporter = nodemailer.createTransport({
      //   host: 'smtp.gmail.com', // Replace with your SMTP server hostname
      //   port: 465, // Replace with your SMTP server port
      //   secure: true, // Set to true if your SMTP server requires SSL/TLS
      //   auth: {
      //       type: ' OAuth2',
      //     user: process.env.email, // Replace with your email address
      //     pass: process.env.pass, // Replace with your email password
      //   },
      //   tls: {
      //       ciphers:'SSLv3'
      //   }
      // });
  
      // // Prepare the email content
      // let mailOptions = {
      //   from: '"name"<Your_email>',
      //   to: email,
      //   subject: 'Registration Successful',
      //   text: 'Hello! Thank you for registering', // Plain text body
      //   html: `<p>
      //   Dear ${name},
      //     <br>
      //     <br>
      //   Warm greetings from Kum Kum beauty parlour! We wanted to reach out and express our heartfelt appreciation for registering with us. We are absolutely thrilled to welcome you to our esteemed beauty parlour! on date: <b> ${thedate} <b>       
      //   <br>
        
      //   Wishing you beauty and bliss,
      //   <br>
      //   <br>
      //   Kum Kum
      

      //   </p> `, // HTML body
      // };
  
      // try {
      //   // Send the email
      //   let info = await transporter.sendMail(mailOptions);
      //   console.log('Message sent: %s', info.messageId);
      //   console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
      // } catch (error) {
      //   console.log('Error sending email:', error);
      // }

      // let mailOptions1 = {
      //   from: '"name" <your_email>',
      //   to: 'email',
      //   subject: 'New Registration',
      //   text: `New registration, ${name}`, // Plain text body
      //   html: ` Name:  ${name} <br>
      //   Phone No.:  ${number} <br>
      //   Email: ${email}
      //   On Date: ${thedate}`, // HTML body
      // };
  
      // try {
      //   // Send the email
      //   let info = await transporter.sendMail(mailOptions1);
      //   console.log('Message sent: %s', info.messageId);
      //   console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
      // } catch (error) {
      //   console.log('Error sending email:', error);
      // }

    } catch (err) {
      console.error('error', err);
    }
  });
  

app.get('/admin',(req,res)=>{
    res.sendFile(__dirname+'/frontend/admin.html')

})
var username, pass
app.post('/admin',(req,res)=>{
   username = req.body.user
   pass = req.body.pass
})


app.post('/ADMIN_ROUTE/:id',async (req,res) =>{
    let userId = req.params.id
    try{
     await user.findByIdAndDelete(userId)
      res.redirect('/ADMIN_ROUTE')
    }catch(err){
      console.error(err)
    }
  })





app.get('/ADMIN_ROUTE', async (req,res)=>{
 try{
  var users = await user.find({})
  var userList = [...users]
  res.render('adminpage',{userList: userList})
 }
 catch(err){
  console.log('errror')
  res.send('Internal server error')
 }
})

connectToMongoDB()
app.listen( 3000 || process.env.PORT  ,(req,res)=>{
    console.log(`server listening `)
})
